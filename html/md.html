<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Akinator Full JSON Viewer + Manage Session</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
    input, button { padding: 8px; margin: 5px 0; width: 100%; }
    pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
    img { max-width: 150px; display: block; margin-top: 10px; }
    .section { border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Akinator Full JSON Viewer + Manage Session</h1>

  <div class="section">
    <button id="startBtn">Start Game</button>
  </div>

  <div class="section" id="answerSection" style="display:none;">
    <label>Step:</label>
    <input type="number" id="step" value="0" />

    <label>Progression:</label>
    <input type="text" id="progression" value="0.0" />

    <label>Answer (0=yes,1=no,2=idk,3=probably,4=probably not):</label>
    <input type="text" id="answer" value="0" />

    <button id="sendAnswerBtn">Send Answer</button>
    <button id="backBtn">Back</button>
    <button id="listBtn">List (عدّ/اقتراحات)</button>
    <button id="cancelBtn">Cancel Session</button>
  </div>

  <h2>JSON Response:</h2>
  <pre id="jsonOutput">{}</pre>
  <div id="imageContainer"></div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const sendAnswerBtn = document.getElementById('sendAnswerBtn');
    const backBtn = document.getElementById('backBtn');
    const listBtn = document.getElementById('listBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const answerSection = document.getElementById('answerSection');
    const jsonOutput = document.getElementById('jsonOutput');
    const imageContainer = document.getElementById('imageContainer');

    const stepInput = document.getElementById('step');
    const progInput = document.getElementById('progression');
    const answerInput = document.getElementById('answer');

    let session = "";
    let signature = "";

    function pretty(obj){ try { return JSON.stringify(obj, null, 2); } catch(e){ return String(obj); } }

    async function postAPI(url, body) {
      const formData = new URLSearchParams();
      for (const key in body) {
        formData.append(key, body[key]);
      }
      
      const res = await fetch(url, { 
        method: 'POST', 
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData 
      });
      return res.json();
    }

    async function updateJSONDisplay(data){
      jsonOutput.textContent = pretty(data);
      const imgUrl = data.djinn_picture || data.photo;
      imageContainer.innerHTML = imgUrl ? `<img src="${imgUrl}" alt="Picture"/>` : "";
      if(data.step !== undefined) stepInput.value = data.step;
      if(data.progression !== undefined) progInput.value = data.progression;
    }

    startBtn.addEventListener('click', async () => {
      try {
        const data = await postAPI('https://dante-pi.vercel.app/api/marid', {});
        session = data.session;
        signature = data.signature;
        await updateJSONDisplay(data);
        answerSection.style.display = 'block';
      } catch(err){ 
        jsonOutput.textContent = "Error: " + err.message; 
        console.error("Start error:", err);
      }
    });

    sendAnswerBtn.addEventListener('click', async () => {
      try {
        const body = {
          step: stepInput.value,
          progression: progInput.value,
          answer: answerInput.value,
          session,
          signature,
          cm: "false",
          sid: "NaN",
          question_filter: "string",
          step_last_proposition: ""
        };
        const data = await postAPI('https://dante-pi.vercel.app/api/marid1', body);
        await updateJSONDisplay(data);
      } catch(err){ 
        jsonOutput.textContent = "Error: " + err.message; 
        console.error("Send answer error:", err);
      }
    });

    backBtn.addEventListener('click', async () => {
      try {
        const body = { 
          step: stepInput.value, 
          progression: progInput.value, 
          session, 
          signature, 
          cm: "false" 
        };
        const data = await postAPI('https://dante-pi.vercel.app/api/marid2', body);
        await updateJSONDisplay(data);
      } catch(err){ 
        jsonOutput.textContent = "Error: " + err.message; 
        console.error("Back error:", err);
      }
    });

    listBtn.addEventListener('click', async () => {
      try {
        const body = { session, signature, step: stepInput.value };
        const data = await postAPI('https://dante-pi.vercel.app/api/list', body);
        await updateJSONDisplay(data);
      } catch(err){ 
        jsonOutput.textContent = "Error: " + err.message; 
        console.error("List error:", err);
      }
    });

    cancelBtn.addEventListener('click', async () => {
      try {
        const body = { session, signature };
        const data = await postAPI('https://dante-pi.vercel.app/api/cancel', body);
        await updateJSONDisplay(data);
        answerSection.style.display = 'none';
      } catch(err){ 
        jsonOutput.textContent = "Error: " + err.message; 
        console.error("Cancel error:", err);
      }
    });
  </script>
</body>
</html>
